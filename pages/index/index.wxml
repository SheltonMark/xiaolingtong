<!--pages/index/index.wxml-->
<view class="index-page">
  <!-- 固定顶部区域（整体一块，无缝隙） -->
  <view class="fixed-header" style="padding-top: {{statusBarHeight}}px;">
    <!-- 标题行（与胶囊同行） -->
    <view class="nav-bar-inner" style="height: {{menuHeight}}px;">
      <text class="nav-title">{{userRole === 'enterprise' ? '首页' : '临时工'}}</text>
    </view>
    <!-- 搜索行 -->
    <view class="top-bar-inner">
      <view class="city-selector" bindlongpress="onSwitchRole">
        <text class="city-icon iconfont icon-address {{userRole === 'enterprise' ? 'text-cta' : 'text-primary'}}"></text>
        <text class="city-name">东莞</text>
      </view>
      <view class="search-bar" bindtap="onSearch">
        <text class="search-icon iconfont icon-chakan"></text>
        <text class="search-placeholder">{{userRole === 'enterprise' ? '搜索产品/工艺/工厂' : '搜索工种/地区'}}</text>
      </view>
      <view class="notify-btn" bindtap="onNotification">
        <text class="notify-icon iconfont icon-tongzhi"></text>
        <view class="notify-badge">3</view>
      </view>
    </view>
    <!-- 企业端 Tab -->
    <view class="tab-bar-ent" wx:if="{{userRole === 'enterprise'}}">
      <view class="tab-item {{currentTab === index ? 'tab-active' : ''}}"
            wx:for="{{tabs}}" wx:key="index"
            data-index="{{index}}" bindtap="onTabChange">
        <text class="tab-text">{{item}}</text>
        <view class="tab-line" wx:if="{{currentTab === index}}"></view>
      </view>
    </view>
    <!-- 临工端筛选 -->
    <view class="filter-bar" wx:if="{{userRole === 'worker'}}">
      <view class="filter-item" wx:for="{{filterLabels}}" wx:key="index">
        <text class="filter-text">{{item}}</text>
        <text class="filter-arrow">⌄</text>
      </view>
    </view>
  </view>

  <view class="content-spacer" style="height: {{headerHeight ? headerHeight + 'px' : (navBarHeight + (userRole === 'enterprise' ? 140 : 110)) + 'px'}};"></view>

  <!-- ===== 企业端内容 ===== -->
  <view wx:if="{{userRole === 'enterprise'}}">
    <!-- 广告 Banner -->
    <view class="banner-wrap">
      <view class="banner-inner">
        <image src="https://picsum.photos/700/280"
               class="banner-img" mode="aspectFill" />
      </view>
    </view>

    <!-- Tab 0: 采购需求 -->
    <view wx:if="{{currentTab === 0}}">
      <view class="cate-grid-wrap">
        <view class="cate-grid">
          <view class="cate-item" wx:for="{{catePurchase}}" wx:key="label">
            <view class="cate-icon {{item.active ? 'cate-icon-active' : ''}}" style="background-color: {{item.active ? '#3B82F6' : item.bg}};">
              <text class="cate-icon-text {{item.active ? 'cate-icon-text-white' : ''}}" style="{{item.active ? '' : 'color:' + (item.iconColor || '#64748B')}}">{{item.icon}}</text>
            </view>
            <text class="cate-label {{item.active ? 'cate-label-active' : ''}}">{{item.label}}</text>
          </view>
        </view>
      </view>
      <view class="list-wrap">
        <view class="section-header">
          <text class="section-title">最新采购需求</text>
          <text class="section-more">查看更多</text>
        </view>
        <info-card wx:for="{{purchaseList}}" wx:key="id"
                   item="{{item}}"
                   bind:tap="onCardTap"
                   bind:wechat="onWechat"
                   bind:phone="onPhone"
                   bind:chat="onChat"
                   bind:report="onReport" />
        <empty-state wx:if="{{purchaseList.length === 0}}" text="暂无采购需求" />
      </view>
    </view>

    <!-- Tab 1: 工厂库存 -->
    <view wx:if="{{currentTab === 1}}">
      <view class="cate-grid-wrap">
        <view class="cate-grid">
          <view class="cate-item" wx:for="{{cateStock}}" wx:key="label">
            <view class="cate-icon {{item.active ? 'cate-icon-active' : ''}}" style="background-color: {{item.active ? '#3B82F6' : item.bg}};">
              <text class="cate-icon-text {{item.active ? 'cate-icon-text-white' : ''}}" style="{{item.active ? '' : 'color:' + (item.iconColor || '#64748B')}}">{{item.icon}}</text>
            </view>
            <text class="cate-label {{item.active ? 'cate-label-active' : ''}}">{{item.label}}</text>
          </view>
        </view>
      </view>
      <view class="list-wrap">
        <view class="section-header">
          <text class="section-title">最新工厂库存</text>
          <text class="section-more">查看更多</text>
        </view>
        <info-card wx:for="{{stockList}}" wx:key="id"
                   item="{{item}}"
                   bind:tap="onCardTap"
                   bind:wechat="onWechat"
                   bind:phone="onPhone"
                   bind:chat="onChat"
                   bind:report="onReport" />
        <empty-state wx:if="{{stockList.length === 0}}" text="暂无库存信息" />
      </view>
    </view>

    <!-- Tab 2: 代加工 -->
    <view wx:if="{{currentTab === 2}}">
      <view class="cate-grid-wrap">
        <view class="cate-grid">
          <view class="cate-item" wx:for="{{cateProcess}}" wx:key="label">
            <view class="cate-icon {{item.active ? 'cate-icon-active' : ''}}" style="background-color: {{item.active ? '#3B82F6' : item.bg}};">
              <text class="cate-icon-text {{item.active ? 'cate-icon-text-white' : ''}}" style="{{item.active ? '' : 'color:' + (item.iconColor || '#64748B')}}">{{item.icon}}</text>
            </view>
            <text class="cate-label {{item.active ? 'cate-label-active' : ''}}">{{item.label}}</text>
          </view>
        </view>
      </view>
      <view class="list-wrap">
        <view class="section-header">
          <text class="section-title">最新代加工</text>
          <text class="section-more">查看更多</text>
        </view>
        <info-card wx:for="{{processList}}" wx:key="id"
                   item="{{item}}"
                   bind:tap="onCardTap"
                   bind:wechat="onWechat"
                   bind:phone="onPhone"
                   bind:chat="onChat"
                   bind:report="onReport" />
        <empty-state wx:if="{{!processList || processList.length === 0}}" text="暂无代加工信息" />
      </view>
    </view>

    <!-- Tab 3: 发布招工 -->
    <view wx:if="{{currentTab === 3}}">
      <view class="cate-grid-wrap">
        <view class="cate-grid">
          <view class="cate-item" wx:for="{{cateJob}}" wx:key="label">
            <view class="cate-icon {{item.active ? 'cate-icon-active' : ''}}" style="background-color: {{item.active ? '#3B82F6' : item.bg}};">
              <text class="cate-icon-text {{item.active ? 'cate-icon-text-white' : ''}}" style="{{item.active ? '' : 'color:' + (item.iconColor || '#64748B')}}">{{item.icon}}</text>
            </view>
            <text class="cate-label {{item.active ? 'cate-label-active' : ''}}">{{item.label}}</text>
          </view>
        </view>
      </view>
      <view class="list-wrap">
        <view class="section-header">
          <text class="section-title">最新招工信息</text>
          <text class="section-more">查看更多</text>
        </view>
        <view class="job-card" wx:for="{{jobListEnterprise}}" wx:key="id"
              data-id="{{item.id}}" bindtap="onJobTap">
          <view class="job-header">
            <view class="job-header-left">
              <view class="text-avatar text-avatar-lg" style="background-color:#10B981;">{{item.companyName[0]}}</view>
              <view class="job-company-info">
                <text class="job-company">{{item.companyName}}</text>
                <text class="job-meta">{{item.time}} · {{item.location}}</text>
              </view>
            </view>
            <view class="contact-btns">
              <view class="contact-btn btn-wechat" catchtap="onWechat" data-id="{{item.id}}">微信</view>
              <view class="contact-btn btn-phone" catchtap="onPhone" data-id="{{item.id}}">电话</view>
            </view>
          </view>
          <text class="job-salary-line"><text class="text-cta font-semibold">{{item.salary}}</text> · {{item.title}}<text wx:if="{{item.urgent}}" class="text-rose"> · 急招</text></text>
          <text class="job-desc">{{item.desc}}</text>
          <view class="job-footer">
            <text class="job-applied">已报名 {{item.applied}}/{{item.total}}人</text>
            <view class="job-actions">
              <view class="job-action-item">
                <text class="action-icon iconfont icon-fenxiang"></text>
                <text class="job-action">分享</text>
              </view>
              <view class="job-action-item" catchtap="onReport" data-id="{{item.id}}">
                <text class="action-icon iconfont icon-tishixinxi"></text>
                <text class="job-action">投诉</text>
              </view>
            </view>
          </view>
        </view>
        <empty-state wx:if="{{!jobListEnterprise || jobListEnterprise.length === 0}}" text="暂无招工信息" />
      </view>
      <!-- 悬浮发布招工按钮 -->
      <view class="fab-publish" bindtap="onPublishJob">
        <text class="fab-publish-icon">+</text>
        <text class="fab-publish-text">发布</text>
      </view>
    </view>

    <!-- Tab 4: 工厂名录 -->
    <view wx:if="{{currentTab === 4}}">
      <view class="cate-grid-wrap">
        <view class="cate-grid">
          <view class="cate-item" wx:for="{{cateFactory}}" wx:key="label">
            <view class="cate-icon {{item.active ? 'cate-icon-active' : ''}}" style="background-color: {{item.active ? '#3B82F6' : item.bg}};">
              <text class="cate-icon-text {{item.active ? 'cate-icon-text-white' : ''}}" style="{{item.active ? '' : 'color:' + (item.iconColor || '#64748B')}}">{{item.icon}}</text>
            </view>
            <text class="cate-label {{item.active ? 'cate-label-active' : ''}}">{{item.label}}</text>
          </view>
        </view>
      </view>
      <view class="list-wrap">
        <view class="section-header">
          <text class="section-title">工厂名录</text>
          <text class="section-more">查看更多</text>
        </view>
        <view class="factory-card" wx:for="{{factoryList}}" wx:key="id">
          <view class="factory-top">
            <image wx:if="{{item.image}}" src="{{item.image}}" class="factory-logo-img" mode="aspectFill" />
            <view wx:else class="factory-logo iconfont icon-gongchang"></view>
            <view class="factory-info">
              <text class="factory-name">{{item.name}}</text>
              <text class="factory-sub">{{item.type}} · {{item.location}}</text>
            </view>
          </view>
          <view class="factory-tags">
            <text class="factory-tag tag-blue">已认证</text>
            <text class="factory-tag" style="background-color:{{item.scaleBg}};color:{{item.scaleColor}};">{{item.scale}}</text>
            <text class="factory-years">入驻{{item.years}}年</text>
          </view>
        </view>
        <empty-state wx:if="{{!factoryList || factoryList.length === 0}}" text="暂无工厂" />
      </view>
    </view>
  </view>

  <!-- ===== 临工端内容 ===== -->
  <view wx:if="{{userRole === 'worker'}}" class="worker-list-wrap">
    <view class="job-card" wx:for="{{jobList}}" wx:key="id"
          data-id="{{item.id}}" bindtap="onJobTap">
      <view class="job-header">
        <view class="job-header-left">
          <view class="text-avatar text-avatar-lg" style="background-color:#10B981;">{{item.companyName[0]}}</view>
          <view class="job-company-info">
            <text class="job-company">{{item.companyName}}</text>
            <text class="job-meta">{{item.dateRange}} · {{item.location}} · {{item.distance}}</text>
          </view>
        </view>
        <view class="contact-btns">
          <view class="contact-btn btn-wechat" catchtap="onWechat" data-id="{{item.id}}">微信</view>
          <view class="contact-btn btn-phone" catchtap="onPhone" data-id="{{item.id}}">电话</view>
        </view>
      </view>
      <text class="job-salary-line"><text class="text-cta font-semibold">{{item.salary}}{{item.salaryUnit}}</text> · {{item.title}}<text wx:if="{{item.tagText}}" class="{{item.tagColor}}"> · {{item.tagText}}</text></text>
      <text class="job-desc">{{item.desc}}</text>
      <!-- 图片网格 -->
      <view class="job-images" wx:if="{{item.images && item.images.length > 0}}">
        <view class="job-img-wrap" wx:for="{{item.images}}" wx:for-item="img" wx:key="*this">
          <image src="{{img}}" mode="aspectFill" class="job-img" />
        </view>
      </view>
      <view class="job-footer">
        <text class="job-applied">已报名 {{item.applied}}/{{item.need}}人</text>
        <view class="job-actions">
          <view class="job-action-item">
            <text class="action-icon">↗</text>
            <text class="job-action">分享</text>
          </view>
          <view class="job-action-item" catchtap="onReport" data-id="{{item.id}}">
            <text class="action-icon iconfont icon-tishixinxi"></text>
            <text class="job-action">投诉</text>
          </view>
        </view>
      </view>
    </view>
    <empty-state wx:if="{{jobList.length === 0}}" text="暂无招工信息" subText="附近暂时没有招工需求" />
  </view>
</view>
