# 支付与财务模块

## 1. 模块概述

本模块涵盖平台所有资金相关功能：
- 会员购买
- 查看机会购买
- 广告位/置顶购买
- 用工工资支付
- 临工提现

**技术依赖**：微信支付（需微信商户号）

---

## 2. 收费项目总览

| 收费项目 | 付费方 | 说明 |
|---------|-------|------|
| 会员费 | 企业用户 | 月会员/年会员，无限次查看联系方式 |
| 查看机会 | 企业用户 | 单次购买，查看联系方式消耗 |
| 广告位 | 企业用户 | 首页广告位展示 |
| 信息置顶 | 企业用户 | 发布的信息置顶展示 |
| 用工工资 | 企业用户 | 支付临工工资（含平台抽成） |

**重要**：所有价格、比例均**后台可配置**，代码中不写死任何数值。

---

## 3. 会员体系

### 3.1 会员类型

| 会员类型 | 有效期 | 权益 | 价格 |
|---------|-------|------|------|
| 普通用户 | - | 需消耗查看机会 | 免费 |
| 月会员 | 30天 | 无限次查看联系方式 | 后台配置 |
| 年会员 | 365天 | 无限次查看联系方式 | 后台配置 |

### 3.2 会员购买流程

```
┌─────────────────────────────────────────┐
│  会员中心                               │
├─────────────────────────────────────────┤
│  当前状态：普通用户                      │
│  查看机会剩余：5次                       │
├─────────────────────────────────────────┤
│  开通会员                               │
│  ┌─────────────────────────────────┐   │
│  │ ○ 月会员                         │   │
│  │   ¥XX/月                        │   │
│  │   无限次查看联系方式              │   │
│  ├─────────────────────────────────┤   │
│  │ ○ 年会员（推荐）                  │   │
│  │   ¥XX/年（省¥XX）               │   │
│  │   无限次查看联系方式              │   │
│  └─────────────────────────────────┘   │
├─────────────────────────────────────────┤
│  [立即开通]                             │
└─────────────────────────────────────────┘
         │
         ▼
    微信支付
         │
         ▼
    支付成功
         │
         ▼
    会员生效
    推送开通成功通知
```

### 3.3 会员续费

- 会员到期前7天推送续费提醒
- 到期后自动降级为普通用户
- 续费时长累加（如还剩10天时续费月会员，则有效期为10+30=40天）

### 3.4 会员权益判断逻辑

```javascript
// 伪代码
function isMember(user) {
  if (!user.memberExpireTime) return false;
  return new Date() < new Date(user.memberExpireTime);
}

function canViewContact(user) {
  return isMember(user) || user.viewChances > 0;
}
```

---

## 4. 查看机会

### 4.1 获取方式

| 方式 | 说明 |
|-----|------|
| 新用户赠送 | 注册时赠送N次（后台配置，可为0） |
| 购买 | 付费购买 |
| 分享获取 | 待确认功能，暂不实现 |

### 4.2 购买流程

```
┌─────────────────────────────────────────┐
│  购买查看机会                           │
├─────────────────────────────────────────┤
│  当前剩余：5次                          │
├─────────────────────────────────────────┤
│  选择套餐                               │
│  ┌─────────────────────────────────┐   │
│  │ ○ 10次 - ¥XX                    │   │
│  │ ○ 50次 - ¥XX（推荐）            │   │
│  │ ○ 100次 - ¥XX                   │   │
│  └─────────────────────────────────┘   │
│  （套餐后台可配置）                      │
├─────────────────────────────────────────┤
│  [立即购买]                             │
└─────────────────────────────────────────┘
         │
         ▼
    微信支付
         │
         ▼
    支付成功
         │
         ▼
    查看机会增加
```

### 4.3 有效期管理

| 配置项 | 说明 | 默认值 |
|-------|------|--------|
| 查看机会有效期 | 获取后N天内有效 | 7天（后台可配） |

- 每次获取的查看机会独立计算有效期
- 使用时优先消耗即将过期的机会（FIFO）
- 过期的机会自动失效，不退款

### 4.4 消耗规则

- 查看一个联系方式消耗1次机会
- 同一条信息重复查看**不再消耗**（已解锁的永久可见）
- 会员用户查看不消耗机会

---

## 5. 广告位

### 5.1 广告位类型

| 位置 | 说明 | 展示形式 |
|-----|------|---------|
| 首页Banner | 首页顶部轮播图 | 图片+跳转链接 |
| 首页推荐位 | 首页中部推荐区域 | 图片+跳转链接 |

### 5.2 购买流程

```
┌─────────────────────────────────────────┐
│  广告位购买                             │
├─────────────────────────────────────────┤
│  选择广告位                             │
│  ○ 首页Banner - ¥XX/天                 │
│  ○ 首页推荐位 - ¥XX/天                 │
├─────────────────────────────────────────┤
│  选择时长                               │
│  开始日期：[日期选择]                    │
│  结束日期：[日期选择]                    │
│  共 N 天，合计 ¥XXX                     │
├─────────────────────────────────────────┤
│  上传广告素材                           │
│  [+ 上传图片]                           │
│  建议尺寸：750 x 300 px                 │
├─────────────────────────────────────────┤
│  跳转链接                               │
│  ○ 跳转到我的某条发布信息               │
│  ○ 跳转到外部链接                       │
├─────────────────────────────────────────┤
│  [提交审核并支付]                       │
└─────────────────────────────────────────┘
         │
         ▼
    微信支付
         │
         ▼
    进入审核队列
         │
         ▼
    管理员审核
         │
    ┌────┴────┐
    ▼         ▼
  通过       驳回
    │         │
    ▼         ▼
 到期自动   退款
 上线展示
```

### 5.3 广告位管理

- 同一广告位同一时间可有多个广告（轮播展示）
- 管理员可在后台设置每个广告位的最大数量
- 广告到期自动下线

---

## 6. 信息置顶

### 6.1 置顶规则

- 置顶信息在列表顶部展示，带"置顶"标识
- 多个置顶信息按购买时间排序
- 置顶期间信息被下架，不退款

### 6.2 购买流程

```
我的发布 - 某条信息
         │
         ▼
    点击"推广置顶"
         │
         ▼
┌─────────────────────────────────────────┐
│  信息置顶                               │
├─────────────────────────────────────────┤
│  选择时长                               │
│  ○ 1天 - ¥XX                           │
│  ○ 3天 - ¥XX                           │
│  ○ 7天 - ¥XX                           │
│  ○ 30天 - ¥XX                          │
│  （价格后台可配置）                      │
├─────────────────────────────────────────┤
│  [立即支付]                             │
└─────────────────────────────────────────┘
         │
         ▼
    微信支付
         │
         ▼
    置顶立即生效
```

---

## 7. 用工工资支付

### 7.1 支付流程

```
┌─────────────────────────────────────────────────────────────┐
│                      工资支付流程                            │
└─────────────────────────────────────────────────────────────┘

1. 收工结算
   临时管理员提交核验单 ──→ 临工确认（或超时自动确认）
         │
         ▼
2. 待付款状态
   系统生成付款单
   ┌─────────────────────────────────────────┐
   │  付款单                                 │
   │  ─────────────────────                  │
   │  用工需求：组装工                        │
   │  工作日期：2026-01-20                   │
   │  ─────────────────────                  │
   │  临工工资总额：¥1500                    │
   │  平台服务费：¥375                       │
   │  ─────────────────────                  │
   │  应付总额：¥1875                        │
   └─────────────────────────────────────────┘
         │
         ▼
3. 工厂支付
   点击"立即支付" ──→ 微信支付 ──→ 支付成功
         │
         ▼
4. 系统分账
   ┌─────────────────────────────────────────┐
   │  平台收入：¥375 ──→ 平台账户            │
   │  临工工资：¥1500 ──→ 各临工余额         │
   │  管理员服务费：¥XX ──→ 管理员余额       │
   └─────────────────────────────────────────┘
         │
         ▼
5. 通知
   推送临工"工资到账"通知
```

### 7.2 分账明细

```
工厂支付总额 = 临工工资总额 + 平台抽成

其中：
- 临工工资总额 = Σ(每个临工的工时/计件 × 临工看到的单价)
- 平台抽成 = 临工工资总额 × 抽成比例 / (1 - 抽成比例)

或者换一种理解方式：
- 工厂设定单价 = 25元/小时
- 平台抽成比例 = 20%
- 临工实际单价 = 25 × (1-20%) = 20元/小时
- 工厂支付 = 25元/小时 × 工时
- 平台收入 = 5元/小时 × 工时
- 临工收入 = 20元/小时 × 工时
```

### 7.3 临时管理员服务费

```
管理员服务费 = 监管人数 × 服务费单价 × 工时/件数

服务费单价：后台可配置，可针对单个订单调整
服务费从平台收入中支出，不额外向工厂收取
```

---

## 8. 临工提现

### 8.1 提现规则

| 规则 | 说明 |
|-----|------|
| 提现时间 | 随时可提现 |
| 到账方式 | 微信零钱 |
| 手续费 | 免费（平台承担） |
| 最低提现金额 | 无限制（后台可配置） |

### 8.2 提现流程

```
┌─────────────────────────────────────────┐
│  我的钱包                               │
├─────────────────────────────────────────┤
│  可提现余额：¥ 520.00                   │
│  [提现]                                 │
├─────────────────────────────────────────┤
│  收入明细 >                             │
│  提现记录 >                             │
└─────────────────────────────────────────┘
         │
         ▼
    点击"提现"
         │
         ▼
┌─────────────────────────────────────────┐
│  提现                                   │
├─────────────────────────────────────────┤
│  提现金额                               │
│  [¥ 520.00]  [全部提现]                 │
├─────────────────────────────────────────┤
│  到账方式：微信零钱                      │
│  预计到账：即时到账                      │
├─────────────────────────────────────────┤
│  [确认提现]                             │
└─────────────────────────────────────────┘
         │
         ▼
    调用微信企业付款到零钱
         │
         ▼
    到账成功
         │
         ▼
    推送"提现成功"通知
```

### 8.3 提现记录

```
┌─────────────────────────────────────────┐
│  提现记录                               │
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────┐   │
│  │ 提现 ¥520.00                    │   │
│  │ 2026-01-20 15:30                │   │
│  │ 状态：已到账 ✅                  │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ 提现 ¥300.00                    │   │
│  │ 2026-01-15 10:20                │   │
│  │ 状态：已到账 ✅                  │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

---

## 9. 收入明细

### 9.1 临工收入明细

```
┌─────────────────────────────────────────┐
│  收入明细                               │
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────┐   │
│  │ +¥160.00                        │   │
│  │ 组装工 - xxx公司                 │   │
│  │ 2026-01-20                      │   │
│  │ 工时：8小时 × ¥20/小时          │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ +¥50.00                         │   │
│  │ 监管服务费                       │   │
│  │ 2026-01-20                      │   │
│  │ 监管人数：10人                   │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

---

## 10. 财务数据统计（后台）

### 10.1 收入统计

| 统计项 | 说明 |
|-------|------|
| 会员收入 | 月会员/年会员购买金额 |
| 查看机会收入 | 查看机会购买金额 |
| 广告位收入 | 广告位购买金额 |
| 置顶收入 | 信息置顶购买金额 |
| 用工抽成收入 | 用工工资中的平台抽成 |

### 10.2 支出统计

| 统计项 | 说明 |
|-------|------|
| 临工提现 | 临工提现总额 |
| 管理员服务费 | 临时管理员服务费支出 |
| 微信手续费 | 提现产生的微信手续费 |

---

## 11. 接口清单

| 接口 | 方法 | 说明 |
|-----|------|------|
| /api/payment/member | POST | 购买会员 |
| /api/payment/view-chance | POST | 购买查看机会 |
| /api/payment/ad | POST | 购买广告位 |
| /api/payment/promote | POST | 购买置顶 |
| /api/payment/salary | POST | 支付用工工资 |
| /api/wallet/balance | GET | 获取余额 |
| /api/wallet/withdraw | POST | 提现 |
| /api/wallet/income-list | GET | 收入明细 |
| /api/wallet/withdraw-list | GET | 提现记录 |
| /api/payment/callback | POST | 微信支付回调 |
