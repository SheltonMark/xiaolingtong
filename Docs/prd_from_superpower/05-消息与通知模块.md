# 消息与通知模块

## 1. 模块概述

本模块负责平台内所有消息通知功能：
- 小程序内站内消息
- 微信服务通知（订阅消息）

---

## 2. 通知渠道

| 渠道 | 说明 | 适用场景 |
|-----|------|---------|
| 站内消息 | 小程序内消息中心 | 所有通知 |
| 微信服务通知 | 微信订阅消息推送 | 重要通知（需用户授权） |

---

## 3. 通知场景清单

### 3.1 企业用户通知

| 场景 | 站内消息 | 微信服务通知 | 说明 |
|-----|---------|-------------|------|
| 发布信息审核通过 | ✅ | ✅ | 您发布的"xxx"已审核通过 |
| 发布信息审核驳回 | ✅ | ✅ | 您发布的"xxx"审核未通过，原因：xxx |
| 收到新的询盘消息 | ✅ | ✅ | 有用户对您的"xxx"感兴趣 |
| 有临工报名用工需求 | ✅ | ✅ | 您发布的用工需求有新的报名 |
| 用工订单状态变更 | ✅ | ✅ | 开工/收工/待付款等状态变化 |
| 会员到期提醒 | ✅ | ✅ | 您的会员将于X天后到期 |
| 查看机会即将过期 | ✅ | ✅ | 您有X次查看机会将于X天后过期 |
| 广告位审核结果 | ✅ | ✅ | 广告审核通过/驳回 |
| 广告位即将到期 | ✅ | ✅ | 您的广告位将于X天后到期 |
| 被举报处理结果 | ✅ | ✅ | 您发布的信息因xxx被下架 |

### 3.2 临工用户通知

| 场景 | 站内消息 | 微信服务通知 | 说明 |
|-----|---------|-------------|------|
| 报名结果-入选 | ✅ | ✅ | 恭喜您入选"xxx"用工需求 |
| 报名结果-落选 | ✅ | ✅ | 很遗憾，您未入选"xxx" |
| 被任命为临时管理员 | ✅ | ✅ | 您已被任命为"xxx"的临时管理员 |
| 出勤确认提醒 | ✅ | ✅ | 请确认明天的出勤，截止时间：xxx |
| 出勤确认超时取消 | ✅ | ✅ | 您因未确认出勤已被取消资格 |
| 工资到账 | ✅ | ✅ | 您有一笔工资¥xxx已到账 |
| 提现成功 | ✅ | ✅ | 您的提现¥xxx已到账 |
| 信用分变动 | ✅ | ✅ | 您的信用分发生变化：+X/-X |
| 账号状态变更 | ✅ | ✅ | 账号被限制/解除限制 |

---

## 4. 站内消息

### 4.1 消息中心页面

```
┌─────────────────────────────────────────┐
│  消息中心                               │
├─────────────────────────────────────────┤
│  [全部] [系统通知] [业务消息]            │
├─────────────────────────────────────────┤
│  ┌─────────────────────────────────┐   │
│  │ 🔔 审核通过                      │   │
│  │ 您发布的"保温杯库存"已审核通过    │   │
│  │ 2026-01-20 15:30         [未读] │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ 💰 工资到账                      │   │
│  │ 您有一笔工资¥160.00已到账        │   │
│  │ 2026-01-20 14:00         [已读] │   │
│  └─────────────────────────────────┘   │
│  ┌─────────────────────────────────┐   │
│  │ 📋 报名成功                      │   │
│  │ 恭喜您入选"组装工"用工需求        │   │
│  │ 2026-01-19 10:00         [已读] │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

### 4.2 消息分类

| 分类 | 说明 |
|-----|------|
| 系统通知 | 平台公告、账号状态、审核结果等 |
| 业务消息 | 订单状态、报名结果、工资到账等 |

### 4.3 消息状态

| 状态 | 说明 |
|-----|------|
| 未读 | 用户未查看 |
| 已读 | 用户已查看 |

### 4.4 未读消息提示

- 底部导航栏"消息"图标显示未读数量红点
- 进入消息中心自动标记为已读
- 点击单条消息可跳转到相关页面

---

## 5. 微信服务通知

### 5.1 订阅消息模板

需要在微信公众平台申请以下订阅消息模板：

| 模板名称 | 适用场景 | 模板字段示例 |
|---------|---------|-------------|
| 审核结果通知 | 信息审核通过/驳回 | 审核结果、内容标题、审核时间、备注 |
| 报名结果通知 | 用工报名入选/落选 | 报名结果、岗位名称、工作时间、备注 |
| 订单状态通知 | 用工订单状态变更 | 订单状态、岗位名称、变更时间、备注 |
| 到账通知 | 工资到账、提现成功 | 到账金额、到账类型、到账时间、备注 |
| 提醒通知 | 出勤确认、会员到期 | 提醒内容、截止时间、备注 |

### 5.2 订阅授权流程

```
用户触发需要通知的操作（如报名）
              │
              ▼
       弹出订阅授权弹窗
       "是否允许接收通知？"
              │
         ┌────┴────┐
         ▼         ▼
       允许       拒绝
         │         │
         ▼         ▼
    记录授权状态  仅发站内消息
         │
         ▼
    后续可发送微信服务通知
```

### 5.3 订阅消息发送逻辑

```javascript
// 伪代码
async function sendNotification(userId, type, data) {
  // 1. 发送站内消息（必定发送）
  await createInAppMessage(userId, type, data);

  // 2. 检查用户是否授权微信通知
  const subscription = await getSubscription(userId, type);
  if (subscription && subscription.authorized) {
    // 3. 发送微信服务通知
    await sendWechatMessage(userId, type, data);
  }
}
```

---

## 6. 消息推送时机

### 6.1 实时推送

以下场景触发后立即推送：
- 审核结果
- 报名结果
- 工资到账
- 提现成功
- 信用分变动

### 6.2 定时推送

以下场景按计划时间推送：
- 出勤确认提醒：开工前24小时
- 会员到期提醒：到期前7天
- 查看机会过期提醒：过期前3天
- 广告位到期提醒：到期前3天

---

## 7. 在线客服

### 7.1 接入方式

使用微信小程序客服能力，通过 `<button open-type="contact">` 接入。

### 7.2 客服入口

- 位置：个人中心 → 联系客服
- 点击后打开微信客服会话

### 7.3 客服功能

- 用户可发送文字、图片
- 客服在微信公众平台后台回复
- 支持设置自动回复

---

## 8. 接口清单

| 接口 | 方法 | 说明 |
|-----|------|------|
| /api/message/list | GET | 获取消息列表 |
| /api/message/detail/:id | GET | 获取消息详情 |
| /api/message/read/:id | POST | 标记消息已读 |
| /api/message/read-all | POST | 全部标记已读 |
| /api/message/unread-count | GET | 获取未读消息数量 |
| /api/message/subscribe | POST | 记录订阅授权状态 |
